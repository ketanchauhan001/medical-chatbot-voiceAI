<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Medical RAG Chatbot</title>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #001f3f, #003366);
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  .top-bar {
    padding: 20px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,0.3);
    letter-spacing: 1px;
    color: #001f3f;
    text-shadow: 0 0 5px #ffffff, 0 0 10px #ffffff;
  }

  .chat-wrapper {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(15px);
    position: relative;
  }

  .msg {
    max-width: 70%;
    padding: 12px 18px;
    border-radius: 15px;
    line-height: 1.5;
    font-size: 15px;
    word-wrap: break-word;
    position: relative;
    transition: all 0.3s ease;
  }

  .msg.user {
    align-self: flex-end;
    background: linear-gradient(135deg, #ffffff, #cce0ff);
    color: #001f3f;
    box-shadow: 0 0 10px #ffffff, 0 0 20px #cce0ff;
  }

  .msg.bot {
    align-self: flex-start;
    background: rgba(0,31,63,0.7);
    border: 1px solid rgba(204,224,255,0.5);
    color: #ffffff;
    box-shadow: 0 0 10px #cce0ff, 0 0 15px #cce0ff inset;
  }

  .input-bar {
    display: flex;
    padding: 15px;
    background: rgba(0,31,63,0.8);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255,255,255,0.3);
    gap: 10px;
  }

  #query-input {
    flex: 1;
    padding: 12px;
    font-size: 15px;
    border-radius: 10px;
    border: none;
    outline: none;
    background: rgba(255,255,255,0.15);
    color: #001f3f;
    box-shadow: 0 0 5px #cce0ff inset;
  }

  #query-input::placeholder {
    color: rgba(255,255,255,0.7);
  }

  .btn {
    padding: 12px 18px;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    background: linear-gradient(135deg, #ffffff, #cce0ff);
    color: #001f3f;
    box-shadow: 0 0 10px #ffffff, 0 0 15px #cce0ff;
  }

  .btn:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px #ffffff, 0 0 25px #cce0ff;
  }

  .recording {
    background: linear-gradient(135deg, #ff6666, #ff0000) !important;
    color: #fff !important;
    box-shadow: 0 0 15px #ff6666, 0 0 25px #ff0000 !important;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { box-shadow: 0 0 15px #ff6666, 0 0 25px #ff0000; }
    50% { box-shadow: 0 0 25px #ff6666, 0 0 40px #ff0000; }
    100% { box-shadow: 0 0 15px #ff6666, 0 0 25px #ff0000; }
  }

  .speaking-popup {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(204,224,255,0.2);
    border: 1px solid #cce0ff;
    padding: 40px 60px;
    border-radius: 20px;
    font-size: 22px;
    color: #001f3f;
    text-align: center;
    box-shadow: 0 0 20px #cce0ff, 0 0 40px #cce0ff inset;
    backdrop-filter: blur(20px);
    animation: glow 1.5s infinite alternate;
    cursor: pointer;
    z-index: 100;
  }

  @keyframes glow {
    0% { box-shadow: 0 0 20px #cce0ff, 0 0 40px #cce0ff inset; }
    50% { box-shadow: 0 0 35px #cce0ff, 0 0 60px #cce0ff inset; }
    100% { box-shadow: 0 0 20px #cce0ff, 0 0 40px #cce0ff inset; }
  }

</style>
</head>
<body>

  <div class="top-bar">ü©∫ Medical RAG Chatbot</div>
  <div class="chat-wrapper" id="chat"></div>

  <div class="input-bar">
    <input type="text" id="query-input" placeholder="Type your message...">
    <button class="btn" onclick="sendText()">Send</button>
    <button id="voice-btn" class="btn" onclick="toggleVoice()">üé§</button>
  </div>

  <!-- Speaking Popup -->
  <div id="speaking-popup" class="speaking-popup" style="display:none;">
    üéôÔ∏è Listening...
  </div>

<script>
  /* --------------------------- ADD MESSAGE --------------------------- */
  function addMessage(text, sender) {
    const chat = document.getElementById("chat");
    const msg = document.createElement("div");
    msg.className = "msg " + sender;
    msg.innerText = text;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  /* --------------------------- TEXT SEND --------------------------- */
  async function sendText() {
    const q = document.getElementById("query-input").value;
    if (!q) return;

    addMessage(q, "user");
    document.getElementById("query-input").value = "";

    const r = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: q })
    });

    const data = await r.json();
    addMessage(data.answer, "bot");
  }

  /* --------------------------- VOICE RECORDING --------------------------- */
  let recorder, audioChunks = [];
  let isRecording = false;

  async function toggleVoice() {
    const btn = document.getElementById("voice-btn");
    const popup = document.getElementById("speaking-popup");

    if (isRecording) {
      recorder.stop();
      btn.classList.remove("recording");
      btn.innerHTML = "üé§";
      popup.style.display = "none";
      isRecording = false;
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recorder = new MediaRecorder(stream);

    audioChunks = [];
    recorder.ondataavailable = e => audioChunks.push(e.data);

    recorder.onstop = async () => {
      const blob = new Blob(audioChunks, { type: "audio/wav" });
      const fd = new FormData();
      fd.append("audio", blob, "query.wav");

      addMessage("üéôÔ∏è Processing voice...", "user");

      const res = await fetch("/chat-voice", { method: "POST", body: fd });
      const data = await res.json();

      addMessage("üó£Ô∏è You said: " + data.query_text, "user");
      addMessage(data.answer, "bot");

      if (data.audio) {
        const a = new Audio(data.audio);
        a.play();
      }

      popup.style.display = "none";
      isRecording = false;
      btn.classList.remove("recording");
      btn.innerHTML = "üé§";
    };

    recorder.start();
    isRecording = true;
    btn.classList.add("recording");
    btn.innerHTML = "üî¥";
    popup.style.display = "block";
  }

  // Clicking on popup closes it and stops recording
  document.getElementById("speaking-popup").addEventListener("click", () => {
    if (isRecording) {
      recorder.stop();
    }
  });
</script>

</body>
</html>
